<!doctype html>
<html ng-app="app">
<head>
    <title>Submarine</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/temp.css">
</head>
<body>

<div id="controls">
    <h1>SUBMARINE</h1>
    <input type="text" id="url" readonly>
    
    <div ng-controller="ChatCtrl">
        <h2 ng-if="rtc.connected">Connected Motherfucker!</h2>
        <h2 ng-if="!rtc.connected">Waiting for partner...</h2>
        
        <div class="chat-box">
            <article ng-repeat="msg in messages"><b ng-class="{localuser:msg.local}">{{msg.who}}</b>: {{msg.txt}}</article>
        </div>
        <div class="chat-controls">
            <input ng-disabled="!rtc.connected" type="text" ng-model="message" placeholder="a/s/l?" ng-keypress="$event.keyCode === 13 && sendMessage()">
            <button ng-disabled="!rtc.connected" ng-click="sendMessage()">Send</button>
        </div>
    </div>
    
    
    <div id="placement">
        <input type="number" max="5" min="1" value="1">
        <input type="number" max="5" min="1" value="1">
        <input type="number" max="5" min="1" value="1">
        <button id="rotate">Rotate</button>
        <button id="place">Place</button>
    </div>
</div>
<canvas id="canvas"></canvas>
<div id="audio_controls">
    <img src="img/unmute.svg">
</div>

<audio autoplay loop>
<source src="audio/ambient.ogg" type="audio/ogg">
<source src="audio/ambient.mp3" type="audio/mp3">
</audio>

<script src="js/lib/underscore-min.js"></script>
<script src="js/lib/bluebird.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.10/angular.min.js"></script>
<script src="http://cdn.peerjs.com/0.3/peer.min.js"></script>
<script src="js/lib/babylon.min.js"></script>
<script src="js/lib/hand-1.3.5.js"></script>
<script src="js/gameboard.js"></script>
<script src="js/game.js"></script>
<script src="js/main.js"></script>
<script src="js/rtc.js"></script>

<script>
angular.module('app', [])
    
    .factory('rtc', function($rootScope){
        var listeners = [];
        
        var rtc = {
            connected: false,
            send: null,
            onData: function(func){
                listeners.push(func);
            }
        };
        
        conn.then(function(c){
            $rootScope.$apply(function(){
                rtc.connected = true;
            });
            c.on('data', function(data){
                $rootScope.$apply(function(){
                    _.each(listeners, function(l){
                        l(data);
                    });
                });
            });
            rtc.send = c.send.bind(c);
        });
        
        return rtc;
    })
    
    .controller('ChatCtrl', function($scope, rtc){
        $scope.messages = [];
        $scope.message = '';
        $scope.rtc = rtc;
        
        rtc.onData(function(data){
            if (!data || !data.msgType || data.msgType !== 'chat') return;
            $scope.messages.push({
                who:'Them',
                local: 0,
                txt: data.txt
            });
        });
        
        $scope.sendMessage = function(){
            rtc.send({msgType:'chat', txt:$scope.message});
            $scope.messages.push({
                who:'You',
                local: 1,
                txt: $scope.message
            });
            $scope.message = '';
        };
    })
    
;
</script>

</body>
</html>

